WITH stats AS (
  SELECT
    yyyy_mm,
    net_amount,
    (net_amount - AVG(net_amount) OVER (PARTITION BY yyyy_mm))
      / NULLIF(STDEV(net_amount) OVER (PARTITION BY yyyy_mm), 0) AS zscore,
    order_id,
    CAST(order_date AS DATE) AS order_date
  FROM curated.v_sales_lines
  WHERE tenant_id = @tenant_id
    AND CAST(order_date AS DATE)
        BETWEEN CAST(@from_date AS DATE) AND CAST(@to_date AS DATE)
)

SELECT TOP (@limit)
  order_id,
  order_date,
  yyyy_mm,
  net_amount,
  zscore
FROM stats
WHERE ABS(zscore) > @z
ORDER BY order_date DESC
