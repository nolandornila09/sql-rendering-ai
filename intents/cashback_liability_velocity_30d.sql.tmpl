WITH base AS (
    SELECT
        customer_id,
        as_of_date,
        unredeemed_liability,
        yyyy_mm
    FROM curated.v_cashback_balance_daily
    WHERE tenant_id = @tenant_id
      AND CAST(as_of_date AS DATE) IN (
          CAST(@as_of_date AS DATE),
          DATEADD(DAY,@window_days,CAST(@as_of_date AS DATE))
      )
),
pivoted AS (
    SELECT
        customer_id,
        MAX(CASE WHEN CAST(as_of_date AS DATE) = CAST(@as_of_date AS DATE)
                 THEN unredeemed_liability END) AS liability_today,
        MAX(CASE WHEN CAST(as_of_date AS DATE) = DATEADD(DAY,@window_days,CAST(@as_of_date AS DATE))
                 THEN unredeemed_liability END) AS liability_past
    FROM base
    GROUP BY customer_id
),
calc AS (
    SELECT
        customer_id,
        liability_past,
        liability_today,
        (liability_today - liability_past) AS delta_liability
    FROM pivoted
)
SELECT TOP @limit
    customer_id,
    liability_past AS liability_@window_daysd_ago,
    liability_today,
    delta_liability,
    (YEAR(CAST(@as_of_date AS DATE)) * 100 + MONTH(CAST(@as_of_date AS DATE))) AS yyyy_mm
FROM calc
WHERE delta_liability >= @min_delta
ORDER BY  CASE WHEN @sort_direction = 'ASC'  THEN delta_liability
         ELSE -delta_liability
    END;
