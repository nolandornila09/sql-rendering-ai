WITH base AS (
    SELECT
        customer_id,
        DATEADD(WEEK, DATEDIFF(WEEK, 0, CAST(invoice_date AS DATE)), 0) AS week_start,
        days_to_pay
    FROM curated.v_invoices_closed
    WHERE tenant_id = @tenant_id
      AND CAST(invoice_date AS DATE) 
            BETWEEN DATEADD(DAY,-(@weeks * 7),CAST(@as_of_date AS DATE))
                AND CAST(@as_of_date AS DATE)
),
weekly_median AS (
    SELECT
        customer_id,
        week_start,
        PERCENTILE_CONT(0.5) 
            WITHIN GROUP (ORDER BY days_to_pay)
            OVER (PARTITION BY customer_id, week_start) AS median_days_to_pay
    FROM base
    GROUP BY customer_id, week_start,days_to_pay
),
drift AS (
    SELECT
        customer_id,
        MAX(median_days_to_pay) - MIN(median_days_to_pay) AS delta_days
    FROM weekly_median
    GROUP BY customer_id
)
SELECT TOP @limit
    customer_id,
    delta_days
FROM drift
WHERE delta_days >= @min_delta_days
ORDER BY
CASE WHEN @sort_direction = 'ASC'  THEN delta_days
         ELSE -delta_days
    END;
