WITH base_invoices AS (
    SELECT
        invoice_id,
        customer_id,
        invoice_date,
        due_date,
        amount,
        paid_to_date,
        last_payment_date,
        status,
        yyyy_mm
    FROM curated.v_invoices_ledger
    WHERE tenant_id = @tenant_id
      AND CAST(due_date AS DATE)
            BETWEEN CAST(@as_of_date AS DATE)
                AND DATEADD(DAY, @due_in_days, CAST(@as_of_date AS DATE))
      AND amount >= @min_amount
),
calc AS (
    SELECT
        invoice_id,
        customer_id,
        invoice_date,
        due_date,
        amount,
        paid_to_date,
        ROUND(paid_to_date / NULLIF(amount, 0), 2) AS paid_ratio,
        (1 - (paid_to_date / NULLIF(amount, 0))) AS unpaid_ratio,
        last_payment_date,
        status
    FROM base_invoices
)
SELECT TOP (@limit)
    invoice_id,
    customer_id,
    invoice_date,
    due_date,
    amount,
    paid_to_date,
    paid_ratio,
    unpaid_ratio,
    last_payment_date,
    status
FROM calc
WHERE unpaid_ratio >= @min_unpaid_pct
ORDER BY 
 due_date ,
    CASE WHEN @sort_direction = 'ASC' THEN unpaid_ratio ELSE -unpaid_ratio END;
