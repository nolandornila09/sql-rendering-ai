WITH s AS (
    SELECT 
        customer_id,
        CAST(order_date AS DATE) AS order_date,
        gmv,
        yyyy_mm
    FROM curated.v_gmv_acceleration
    WHERE tenant_id = @tenant_id
      AND CAST(order_date AS DATE) BETWEEN DATEADD(DAY, -@base_win, CAST(@as_of_date AS DATE))
                                      AND CAST(@as_of_date AS DATE)
      AND yyyy_mm >= (YEAR(DATEADD(DAY, -@base_win, CAST(@as_of_date AS DATE))) * 100
                      + MONTH(DATEADD(DAY, -@base_win, CAST(@as_of_date AS DATE))))
)
, accel AS (
    SELECT 
        customer_id,
        SUM(CASE WHEN CAST(order_date AS DATE) > DATEADD(DAY, -@short_win, CAST(@as_of_date AS DATE)) 
                 THEN gmv ELSE 0 END) AS gmv_7d,
        SUM(CASE WHEN CAST(order_date AS DATE) <= DATEADD(DAY, -@short_win, CAST(@as_of_date AS DATE))  
                 THEN gmv ELSE 0 END) AS gmv_28d,
        CASE
            WHEN SUM(CASE WHEN CAST(order_date AS DATE) <= DATEADD(DAY, -@short_win, CAST(@as_of_date AS DATE)) 
                          THEN gmv ELSE 0 END) > 0
            THEN 1.0 * SUM(CASE WHEN CAST(order_date AS DATE) > DATEADD(DAY, -@short_win, CAST(@as_of_date AS DATE)) 
                                 THEN gmv ELSE 0 END) /
                 (SUM(CASE WHEN CAST(order_date AS DATE) <= DATEADD(DAY, -@short_win, CAST(@as_of_date AS DATE)) 
                           THEN gmv ELSE 0 END) / 4.0) - 1.0
            ELSE NULL
        END AS accel_pct
    FROM s
    GROUP BY customer_id
    HAVING SUM(CASE WHEN CAST(order_date AS DATE) <= DATEADD(DAY, -@short_win, CAST(@as_of_date AS DATE))  
                    THEN gmv ELSE 0 END) > 0
       AND (1.0 * SUM(CASE WHEN CAST(order_date AS DATE) > DATEADD(DAY, -@short_win, CAST(@as_of_date AS DATE)) 
                            THEN gmv ELSE 0 END) /
            (SUM(CASE WHEN CAST(order_date AS DATE) <= DATEADD(DAY, -@short_win, CAST(@as_of_date AS DATE)) 
                      THEN gmv ELSE 0 END) / 4.0) - 1.0) >= @min_accel
)
SELECT TOP @limit
    customer_id,
    gmv_7d,
    gmv_28d,
    accel_pct
FROM accel
ORDER BY
    CASE 
        WHEN @sort_direction = 'ASC' THEN accel_pct
        ELSE -accel_pct
    END;
