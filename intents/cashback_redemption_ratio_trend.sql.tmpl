WITH weekly_cashback AS (
    SELECT
        tenant_id,
        YEAR(CAST(as_of_date AS DATE)) AS year_no,
        DATEPART(wk, CAST(as_of_date AS DATE)) AS week_no,
        yyyy_mm,
        SUM(accrued_amount) AS accrued,
        SUM(redeemed_amount) AS redeemed
    FROM curated.v_cashback_balance_daily
    WHERE tenant_id = @tenant_id
      AND CAST(as_of_date AS DATE)
            BETWEEN DATEADD(DAY,-(@weeks * 7),CAST(@as_of_date AS DATE) )
                AND CAST(@as_of_date AS DATE)
    GROUP BY tenant_id,
            YEAR(CAST(as_of_date AS DATE)),
            DATEPART(wk, CAST(as_of_date AS DATE)) ,
             yyyy_mm
)
SELECT TOP @limit
    tenant_id,
    year_no,
    week_no,
    yyyy_mm,
    accrued,
    redeemed,
    CASE WHEN accrued = 0 THEN 0 
         ELSE CAST(redeemed AS FLOAT) / accrued 
    END AS redemption_ratio
FROM weekly_cashback
ORDER BY 
 CASE WHEN @sort_direction = 'ASC'  THEN year_no
         ELSE -year_no
    END,
CASE WHEN @sort_direction = 'ASC'  THEN week_no
         ELSE -week_no
    END;
