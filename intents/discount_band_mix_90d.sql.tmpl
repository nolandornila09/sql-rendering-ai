WITH filtered_sales AS (
    SELECT
        order_id,
        order_date,
        net_amount,
        discount_percent
    FROM curated.v_sales_lines
    WHERE tenant_id = @tenant_id
      AND CAST(order_date AS DATE)  BETWEEN 
          CAST(DATEADD(DAY,-@window_days,CAST(@as_of_date AS DATE))  AS DATE)
          AND CAST(@as_of_date AS DATE)
),
banded_sales AS (
    SELECT
        CASE 
            WHEN discount_percent BETWEEN 0 AND 5 THEN '0-5%'
            WHEN discount_percent > 5 AND discount_percent <= 10 THEN '5-10%'
            WHEN discount_percent > 10 AND discount_percent <= 20 THEN '10-20%'
            ELSE '20%+'
        END AS discount_band,
        net_amount
    FROM filtered_sales
)
SELECT TOP @limit
    discount_band,
    SUM(net_amount) AS gmv_per_band,
    ROUND(SUM(net_amount) * 100.0 / SUM(SUM(net_amount)) OVER (), 2) AS pct_of_total_gmv
FROM banded_sales
GROUP BY discount_band
ORDER BY discount_band ;
